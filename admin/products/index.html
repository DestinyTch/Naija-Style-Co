<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Products - Naija Style Co</title>
        <link rel="stylesheet" href="/assets/js/r-taps.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#CC1000',
                        'deep-black': '#0A0A0A',
                    },
                    fontFamily: {
                        cormorant: ['"Cormorant Garamond"', 'serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #111; }
        .brand-title { font-family: 'Cormorant Garamond', serif; }
        .gold-gradient { background: linear-gradient(135deg, #CC1000, #ff0c0c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Table styles */
        .products-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .products-table th {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #e2e8f0;
        }
        .products-table td {
            border-bottom: 1px solid #f1f5f9;
        }
        .products-table tr:hover td {
            background-color: #f8fafc;
        }
        
        /* Modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Category colors */
        .category-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .category-agbada { background-color: #dbeafe; color: #1e40af; }
        .category-buba { background-color: #fce7f3; color: #9d174d; }
        .category-dansiki { background-color: #dcfce7; color: #166534; }
        .category-aso-oke { background-color: #fef3c7; color: #92400e; }
        .category-ankara { background-color: #e0e7ff; color: #3730a3; }
        .category-gele { background-color: #f3e8ff; color: #6b21a8; }
        .category-isagu { background-color: #fee2e2; color: #991b1b; }
        .category-senator { background-color: #dcfce7; color: #166534; }
        .category-modern { background-color: #f0f9ff; color: #0c4a6e; }
        
        /* Stock indicator */
        .stock-low { color: #dc2626; font-weight: 600; }
        .stock-medium { color: #d97706; font-weight: 600; }
        .stock-high { color: #059669; font-weight: 600; }
        
        /* Image grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }
        .image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .image-thumbnail:hover {
            transform: scale(1.05);
        }
        
        /* File upload area */
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: #CC1000;
            background-color: #fef2f2;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- HEADER -->
<header class="fixed top-0 left-0 right-0 z-50 bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <!-- Logo -->
        <a href="/" class="flex items-center space-x-3 group">
          <img src="/assets/images/logo.png"  class="h-10 w-18 object-contain transition-transform duration-300 group-hover:rotate-12">
        </a>

        <!-- Navigation -->
        <nav class="hidden lg:flex items-center space-x-12">
            <a href="/" class="text-deep-black hover:text-gold font-medium text-lg transition">Home</a>
            <a href="/admin/orders" class="text-deep-black hover:text-gold font-medium text-lg transition">Orders</a>
            <a href="/admin/products" class="text-gold font-medium text-lg transition border-b-2 border-gold pb-1">Products</a>
<a href="/admin/featured-products" class="text-gold font-medium text-lg transition border-gold pb-1">Featured products</a>
            <a href="/admin/customers" class="text-deep-black hover:text-gold font-medium text-lg transition">Customers</a>
        </nav>

        <!-- Right Side -->
        <div class="flex items-center space-x-7">
            <!-- User Section -->
            <div id="user-section"></div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="pt-24 pb-12 max-w-7xl mx-auto px-6">
    <!-- Header Section -->
    <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="brand-title text-4xl font-bold text-deep-black mb-2">Product Management</h1>
            <p class="text-gray-600">Manage your product catalog</p>
        </div>
        <button onclick="openAddProductModal()" 
                class="px-6 py-3 bg-gold text-white rounded-lg font-medium hover:bg-red-700 transition flex items-center gap-2">
            <i class="fas fa-plus"></i>
            Add New Product
        </button>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Products</p>
                    <p class="text-3xl font-bold text-deep-black mt-2" id="total-products">0</p>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <i class="fas fa-boxes text-2xl text-gold"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">In Stock</p>
                    <p class="text-3xl font-bold text-green-600 mt-2" id="in-stock">0</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <i class="fas fa-check-circle text-2xl text-green-500"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Low Stock</p>
                    <p class="text-3xl font-bold text-amber-600 mt-2" id="low-stock">0</p>
                </div>
                <div class="bg-amber-50 p-3 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-2xl text-amber-500"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Out of Stock</p>
                    <p class="text-3xl font-bold text-red-600 mt-2" id="out-of-stock">0</p>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <i class="fas fa-times-circle text-2xl text-red-500"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Actions -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-200">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <!-- Category Filters -->
            <div class="flex flex-wrap gap-2">
                <button onclick="filterProducts('')" class="filter-pill active px-4 py-2 rounded-full bg-gold text-white text-sm font-medium">All Products</button>
                <button onclick="filterProducts('agbada')" class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200">Agbada</button>
                <button onclick="filterProducts('buba')" class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200">Buba & Iro</button>
                <button onclick="filterProducts('dansiki')" class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200">Dansiki</button>
                <button onclick="filterProducts('aso-oke')" class="filter-pill px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200">Aso-Oke</button>
            </div>
            
            <!-- Search and Sort -->
            <div class="flex gap-3">
                <div class="relative">
                    <input type="text" id="search-products" placeholder="Search products..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none w-full md:w-64">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <select id="sort-products" onchange="sortProducts()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                    <option value="stock_low">Stock: Low to High</option>
                    <option value="stock_high">Stock: High to Low</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
            <table class="products-table w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="text-left py-4 px-6">Product</th>
                        <th class="text-left py-4 px-6">Category</th>
                        <th class="text-left py-4 px-6">Price</th>
                        <th class="text-left py-4 px-6">Stock</th>
                        <th class="text-left py-4 px-6">Status</th>
                        <th class="text-left py-4 px-6">Created</th>
                        <th class="text-left py-4 px-6">Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading State -->
        <div id="loading-products" class="p-12 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-gold mx-auto"></div>
            <p class="mt-4 text-gray-500">Loading products...</p>
        </div>
        
        <!-- Empty State -->
        <div id="empty-products" class="p-12 text-center hidden">
            <i class="fas fa-boxes text-5xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No products found</h3>
            <p class="text-gray-500 mb-4">Add your first product to start selling.</p>
            <button onclick="openAddProductModal()" class="px-6 py-2 bg-gold text-white rounded-lg font-medium hover:bg-red-700 transition">
                Add Product
            </button>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="p-4 border-t border-gray-200 flex items-center justify-between hidden">
            <div class="text-sm text-gray-600">
                Showing <span id="start-range">0</span> to <span id="end-range">0</span> of <span id="total-count">0</span> products
            </div>
            <div class="flex gap-2">
                <button onclick="previousPage()" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="prev-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="flex gap-1" id="page-numbers"></div>
                <button onclick="nextPage()" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" id="next-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Add/Edit Product Modal -->
<div id="product-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 overflow-y-auto">
    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-8">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-deep-black" id="modal-title">Add New Product</h2>
            <button onclick="closeProductModal()" class="text-2xl text-gray-400 hover:text-gold transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6">
            <form id="product-form" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- Product Name -->
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
                            <input type="text" id="product-name" name="name" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
                            <p class="text-sm text-gray-500 mt-1">Enter the product title (50-100 characters)</p>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label for="product-description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="product-description" name="description" rows="4"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none"></textarea>
                        </div>
                        
                        <!-- Category -->
                      <div>
    <label for="product-category" class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
    <select id="product-category" name="category" required
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
        
        <option value="">Select Category</option>
        <option value="all">All Products</option>
        <option value="agbada">Agbada</option>
        <option value="buba">Buba & Iro</option>
        <option value="dansiki">Dansiki</option>
        <option value="aso-oke">Aso-Oke</option>
        <option value="ankara">Ankara</option>
        <option value="gele">Gele & Accessories</option>
        <option value="isagu">Isiagu (Igbo)</option>
        <option value="senator">Senator</option>
        <option value="modern">Modern Fusion</option>

    </select>
</div>

                        
                        <!-- Price -->
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700 mb-2">Price (₦) *</label>
                            <input type="number" id="product-price" name="price" step="0.01" min="0" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Stock -->
                        <div>
                            <label for="product-stock" class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
                            <input type="number" id="product-stock" name="stock" min="0" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
                            <div class="flex gap-4 mt-2">
                                <span id="stock-status" class="text-sm font-medium"></span>
                                <span id="stock-message" class="text-sm text-gray-500"></span>
                            </div>
                        </div>
                        
                        <!-- Images Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product Images *</label>
                            <p class="text-sm text-gray-500 mb-3">Upload at least 1 image. Supported formats: JPG, PNG, WEBP (Max 5MB each)</p>
                            
                            <!-- Current Images (Edit mode) -->
                            <div id="current-images" class="mb-4 hidden">
                                <p class="text-sm font-medium text-gray-700 mb-2">Current Images</p>
                                <div id="images-grid" class="image-grid"></div>
                            </div>
                            
                            <!-- File Upload Area -->
                            <div id="file-upload-area" class="file-upload-area p-8 text-center cursor-pointer" 
                                 onclick="document.getElementById('product-images').click()">
                                <input type="file" id="product-images" name="images" multiple accept="image/*" 
                                       class="hidden" onchange="handleImageSelection(event)">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600 font-medium">Click to upload images</p>
                                <p class="text-sm text-gray-500 mt-1">or drag and drop</p>
                            </div>
                            
                            <!-- Selected Images Preview -->
                            <div id="selected-images" class="mt-4 hidden">
                                <p class="text-sm font-medium text-gray-700 mb-2">Selected Images</p>
                                <div id="images-preview" class="image-grid"></div>
                                <button type="button" onclick="clearImageSelection()" 
                                        class="mt-3 text-sm text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash mr-1"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <!-- Additional Fields -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="product-sku" class="block text-sm font-medium text-gray-700 mb-2">SKU</label>
                                <input type="text" id="product-sku" name="sku"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
                            </div>
                            <div>
                                <label for="product-color" class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                                <input type="text" id="product-color" name="color"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Fields -->
                <input type="hidden" id="product-id" name="product_id">
                
                <!-- Form Actions -->
                <div class="flex justify-end gap-3 pt-8 border-t border-gray-200 mt-8">
                    <button type="button" onclick="closeProductModal()" 
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button type="submit" id="submit-button" 
                            class="px-6 py-3 bg-gold text-white rounded-lg font-medium hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        <span id="submit-text">Add Product</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md">
        <div class="p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-deep-black mb-2">Delete Product</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this product? This action cannot be undone.</p>
                <div class="flex justify-center gap-3">
                    <button onclick="closeDeleteModal()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" 
                            class="px-6 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition">
                        Delete Product
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div id="image-viewer" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/90">
    <div class="relative w-full max-w-4xl">
        <button onclick="closeImageViewer()" class="absolute -top-12 right-0 text-white text-3xl hover:text-gold transition">
            <i class="fas fa-times"></i>
        </button>
        <img id="viewer-image" src="" alt="" class="w-full h-auto rounded-lg">
    </div>
</div>

<script>
    const API_URL = "http://localhost:5000";
    let currentUser = null;
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const productsPerPage = 10;
    let currentProductId = null;
    let currentCategoryFilter = '';
    let selectedImages = [];
    let editingProduct = null;
    let isEditMode = false;

    // DOM Elements
    const elements = {
        productsTableBody: document.getElementById('products-table-body'),
        loadingProducts: document.getElementById('loading-products'),
        emptyProducts: document.getElementById('empty-products'),
        pagination: document.getElementById('pagination'),
        totalProducts: document.getElementById('total-products'),
        inStock: document.getElementById('in-stock'),
        lowStock: document.getElementById('low-stock'),
        outOfStock: document.getElementById('out-of-stock'),
        searchInput: document.getElementById('search-products'),
        sortSelect: document.getElementById('sort-products'),
        
        // Modal elements
        modalTitle: document.getElementById('modal-title'),
        productForm: document.getElementById('product-form'),
        productId: document.getElementById('product-id'),
        productName: document.getElementById('product-name'),
        productDescription: document.getElementById('product-description'),
        productCategory: document.getElementById('product-category'),
        productPrice: document.getElementById('product-price'),
        productStock: document.getElementById('product-stock'),
        productSku: document.getElementById('product-sku'),
        productColor: document.getElementById('product-color'),
        currentImages: document.getElementById('current-images'),
        imagesGrid: document.getElementById('images-grid'),
        selectedImages: document.getElementById('selected-images'),
        imagesPreview: document.getElementById('images-preview'),
        submitButton: document.getElementById('submit-button'),
        submitText: document.getElementById('submit-text'),
        stockStatus: document.getElementById('stock-status'),
        stockMessage: document.getElementById('stock-message')
    };

    // Initialize
    async function init() {
        // Check if user is logged in
        const userData = localStorage.getItem('user');
        if (!userData) {
            window.location.href = '/admin/login';
            return;
        }

        currentUser = JSON.parse(userData);
        
        if (currentUser.role !== 'admin') {
            showToast('Unauthorized access', 'error');
            window.location.href = '/';
            return;
        }

        renderLoggedIn();
        await loadProducts();
        
        // Setup event listeners
        elements.searchInput.addEventListener('input', debounce(searchProducts, 300));
        elements.productStock.addEventListener('input', updateStockStatus);
        
        // Setup file upload drag and drop
        setupFileUpload();
        
        // Start SSE for real-time updates
        startSSE();
    }

    // Fetch with custom headers (X-User-Id and X-User-Role)
    async function fetchWithHeaders(url, options = {}) {
        if (!currentUser) {
            throw new Error('User not authenticated');
        }

        const headers = {
            'X-User-Id': currentUser._id || currentUser.id,
            'X-User-Role': currentUser.role,
            ...options.headers
        };
        
        // Don't set Content-Type for FormData
        if (!(options.body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
        }
        
        return fetch(url, { ...options, headers });
    }

    // Load all products
    async function loadProducts() {
        try {
            const res = await fetch(`${API_URL}/products`);
            if (!res.ok) throw new Error('Failed to fetch products');
            
            allProducts = await res.json();
            filteredProducts = [...allProducts];
            
            updateStats();
            sortProducts();
        } catch (error) {
            console.error('Error loading products:', error);
            showToast('Failed to load products', 'error');
            window.location.href = '/admin/login';
        }
    }

    // Update statistics
    function updateStats() {
        const total = allProducts.length;
        const inStock = allProducts.filter(p => p.stock > 10).length;
        const lowStock = allProducts.filter(p => p.stock > 0 && p.stock <= 10).length;
        const outOfStock = allProducts.filter(p => p.stock === 0).length;
        
        elements.totalProducts.textContent = total;
        elements.inStock.textContent = inStock;
        elements.lowStock.textContent = lowStock;
        elements.outOfStock.textContent = outOfStock;
    }

    // Render products table
    function renderProducts() {
        elements.loadingProducts.classList.add('hidden');
        
        if (filteredProducts.length === 0) {
            elements.emptyProducts.classList.remove('hidden');
            elements.productsTableBody.innerHTML = '';
            elements.pagination.classList.add('hidden');
            return;
        }
        
        elements.emptyProducts.classList.add('hidden');
        
        // Calculate pagination
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = Math.min(startIndex + productsPerPage, filteredProducts.length);
        const pageProducts = filteredProducts.slice(startIndex, endIndex);
        
        // Render table rows
        elements.productsTableBody.innerHTML = pageProducts.map(product => `
            <tr class="hover:bg-gray-50 transition">
                <td class="py-4 px-6">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                            ${product.images && product.images.length > 0 ? 
                                `<img src="${product.images[0]}" alt="${product.name}" class="w-full h-full object-cover cursor-pointer" onclick="viewImage('${product.images[0]}')">` :
                                `<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>`
                            }
                        </div>
                        <div>
                            <p class="font-semibold text-deep-black mb-1">${product.name}</p>
                            <p class="text-sm text-gray-600 line-clamp-2">${product.description || 'No description'}</p>
                        </div>
                    </div>
                </td>
                <td class="py-4 px-6">
                    <span class="category-badge category-${product.category || 'other'}">
                        ${getCategoryName(product.category)}
                    </span>
                </td>
                <td class="py-4 px-6">
                    <div class="font-bold text-lg text-gold">₦${product.price.toFixed(2)}</div>
                </td>
                <td class="py-4 px-6">
                    <div class="${getStockClass(product.stock)}">
                        ${product.stock} units
                    </div>
                </td>
                <td class="py-4 px-6">
                    ${product.stock > 0 ? 
                        `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">In Stock</span>` :
                        `<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Out of Stock</span>`
                    }
                </td>
                <td class="py-4 px-6">
                    <div>${formatDate(product.created_at)}</div>
                </td>
                <td class="py-4 px-6">
                    <div class="flex gap-2">
                        <button onclick="editProduct('${product._id}')" 
                                class="px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100 transition">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button onclick="openDeleteModal('${product._id}')" 
                                class="px-3 py-1 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Update pagination
        updatePagination(totalPages, startIndex, endIndex);
    }

    // Update pagination controls
    function updatePagination(totalPages, startIndex, endIndex) {
        if (totalPages <= 1) {
            elements.pagination.classList.add('hidden');
            return;
        }
        
        elements.pagination.classList.remove('hidden');
        
        // Update range display
        document.getElementById('start-range').textContent = startIndex + 1;
        document.getElementById('end-range').textContent = endIndex;
        document.getElementById('total-count').textContent = filteredProducts.length;
        
        // Update page numbers
        const pageNumbers = document.getElementById('page-numbers');
        pageNumbers.innerHTML = '';
        
        for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-3 py-1 rounded-lg ${i === currentPage ? 'bg-gold text-white' : 'border border-gray-300 text-gray-700 hover:bg-gray-50'}`;
            button.onclick = () => goToPage(i);
            pageNumbers.appendChild(button);
        }
        
        // Update prev/next buttons
        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    // Navigation functions
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            renderProducts();
        }
    }

    function nextPage() {
        if (currentPage < Math.ceil(filteredProducts.length / productsPerPage)) {
            currentPage++;
            renderProducts();
        }
    }

    function goToPage(page) {
        currentPage = page;
        renderProducts();
    }

    // Filter products by category
    function filterProducts(category) {
        currentCategoryFilter = category;
        currentPage = 1;
        
        // Update filter pills
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.classList.remove('active');
            pill.classList.remove('bg-gold', 'text-white');
            pill.classList.add('bg-gray-100', 'text-gray-700');
        });
        
        const activeButton = event?.target || document.querySelector(`[onclick="filterProducts('${category}')"]`);
        if (activeButton) {
            activeButton.classList.add('active', 'bg-gold', 'text-white');
            activeButton.classList.remove('bg-gray-100', 'text-gray-700');
        }
        
        if (!category) {
            filteredProducts = [...allProducts];
        } else {
            filteredProducts = allProducts.filter(product => product.category === category);
        }
        
        sortProducts();
    }

    // Search products
    function searchProducts() {
        const query = elements.searchInput.value.toLowerCase();
        
        filteredProducts = allProducts.filter(product => 
            product.name.toLowerCase().includes(query) ||
            product.description.toLowerCase().includes(query) ||
            (product.sku && product.sku.toLowerCase().includes(query)) ||
            (product.category && product.category.toLowerCase().includes(query))
        );
        
        currentPage = 1;
        renderProducts();
    }

    // Sort products
    function sortProducts() {
        const sortBy = elements.sortSelect.value;
        
        filteredProducts.sort((a, b) => {
            switch (sortBy) {
                case 'newest':
                    return new Date(b.created_at) - new Date(a.created_at);
                case 'oldest':
                    return new Date(a.created_at) - new Date(b.created_at);
                case 'price_low':
                    return a.price - b.price;
                case 'price_high':
                    return b.price - a.price;
                case 'stock_low':
                    return a.stock - b.stock;
                case 'stock_high':
                    return b.stock - a.stock;
                default:
                    return 0;
            }
        });
        
        currentPage = 1;
        renderProducts();
    }

    // Open add product modal
    function openAddProductModal() {
        isEditMode = false;
        elements.modalTitle.textContent = 'Add New Product';
        elements.submitText.textContent = 'Add Product';
        elements.productId.value = '';
        
        // Reset form
        elements.productForm.reset();
        clearImageSelection();
        elements.currentImages.classList.add('hidden');
        elements.selectedImages.classList.add('hidden');
        
        // Reset stock status
        updateStockStatus();
        
        // Show modal
        document.getElementById('product-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // Edit product
    async function editProduct(productId) {
        try {
            const product = allProducts.find(p => p._id === productId);
            if (!product) {
                showToast('Product not found', 'error');
                return;
            }
            
            editingProduct = product;
            isEditMode = true;
            elements.modalTitle.textContent = 'Edit Product';
            elements.submitText.textContent = 'Update Product';
            elements.productId.value = product._id;
            
            // Fill form fields
            elements.productName.value = product.name || '';
            elements.productDescription.value = product.description || '';
            elements.productCategory.value = product.category || '';
            elements.productPrice.value = product.price || 0;
            elements.productStock.value = product.stock || 0;
            elements.productSku.value = product.sku || '';
            elements.productColor.value = product.color || '';
            
            // Show current images
            if (product.images && product.images.length > 0) {
                elements.imagesGrid.innerHTML = product.images.map((img, index) => `
                    <div class="relative">
                        <img src="${img}" alt="Product image ${index + 1}" 
                             class="image-thumbnail" onclick="viewImage('${img}')">
                        <button type="button" onclick="removeCurrentImage(${index})" 
                                class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
                elements.currentImages.classList.remove('hidden');
            } else {
                elements.currentImages.classList.add('hidden');
            }
            
            // Clear new images
            clearImageSelection();
            
            // Update stock status
            updateStockStatus();
            
            // Show modal
            document.getElementById('product-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
        } catch (error) {
            console.error('Error loading product for edit:', error);
            showToast('Failed to load product', 'error');
        }
    }

    // Handle form submission
    elements.productForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!validateProductForm()) {
            return;
        }
        
        const formData = new FormData();
        
        // Add form fields
        formData.append('name', elements.productName.value.trim());
        formData.append('description', elements.productDescription.value.trim());
        formData.append('category', elements.productCategory.value);
        formData.append('price', parseFloat(elements.productPrice.value));
        formData.append('stock', parseInt(elements.productStock.value));
        
        // Add optional fields if they exist
        if (elements.productSku.value.trim()) {
            formData.append('sku', elements.productSku.value.trim());
        }
        if (elements.productColor.value.trim()) {
            formData.append('color', elements.productColor.value.trim());
        }
        
        // Add new images
        const fileInput = document.getElementById('product-images');
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('images', fileInput.files[i]);
        }
        
        try {
            let endpoint = `${API_URL}/admin/products`;
            let method = 'POST';
            
            if (isEditMode && elements.productId.value) {
                endpoint = `${API_URL}/admin/products/${elements.productId.value}`;
                method = 'PUT';
            }
            
            const res = await fetchWithHeaders(endpoint, {
                method: method,
                body: formData
            });
            
            if (res.ok) {
                const result = await res.json();
                showToast(isEditMode ? 'Product updated successfully' : 'Product added successfully', 'success');
                
                // Close modal and refresh products
                closeProductModal();
                await loadProducts();
            } else {
                const error = await res.json();
                showToast(error.error || 'Failed to save product', 'error');
            }
        } catch (error) {
            console.error('Error saving product:', error);
            showToast('Network error', 'error');
        }
    });

    // Validate product form
    function validateProductForm() {
        if (!elements.productName.value.trim()) {
            showToast('Product name is required', 'error');
            elements.productName.focus();
            return false;
        }
        
        if (!elements.productCategory.value) {
            showToast('Category is required', 'error');
            elements.productCategory.focus();
            return false;
        }
        
        if (!elements.productPrice.value || parseFloat(elements.productPrice.value) <= 0) {
            showToast('Please enter a valid price', 'error');
            elements.productPrice.focus();
            return false;
        }
        
        if (elements.productStock.value === '' || parseInt(elements.productStock.value) < 0) {
            showToast('Please enter a valid stock quantity', 'error');
            elements.productStock.focus();
            return false;
        }
        
        // In add mode, require at least one image
        if (!isEditMode && selectedImages.length === 0) {
            showToast('Please upload at least one product image', 'error');
            return false;
        }
        
        return true;
    }

    // Close product modal
    function closeProductModal() {
        document.getElementById('product-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        editingProduct = null;
        isEditMode = false;
    }

    // Open delete confirmation modal
    function openDeleteModal(productId) {
        currentProductId = productId;
        document.getElementById('delete-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // Close delete modal
    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        currentProductId = null;
    }

    // Confirm delete
    async function confirmDelete() {
        if (!currentProductId) return;
        
        try {
            const res = await fetchWithHeaders(`${API_URL}/admin/products/${currentProductId}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                showToast('Product deleted successfully', 'success');
                
                // Remove from local arrays
                allProducts = allProducts.filter(p => p._id !== currentProductId);
                filteredProducts = filteredProducts.filter(p => p._id !== currentProductId);
                
                // Update stats and render
                updateStats();
                renderProducts();
                closeDeleteModal();
            } else {
                const error = await res.json();
                showToast(error.error || 'Failed to delete product', 'error');
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            showToast('Network error', 'error');
        }
    }

    // Handle image selection
    function handleImageSelection(event) {
        const files = event.target.files;
        selectedImages = [];
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast(`Image ${file.name} is too large (max 5MB)`, 'error');
                continue;
            }
            
            // Validate file type
            if (!file.type.match('image.*')) {
                showToast(`File ${file.name} is not an image`, 'error');
                continue;
            }
            
            selectedImages.push(file);
        }
        
        updateImagePreview();
    }

    // Update image preview
    function updateImagePreview() {
        elements.imagesPreview.innerHTML = '';
        
        if (selectedImages.length === 0) {
            elements.selectedImages.classList.add('hidden');
            return;
        }
        
        elements.selectedImages.classList.remove('hidden');
        
        selectedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-thumbnail';
                img.alt = file.name;
                img.title = file.name;
                
                const container = document.createElement('div');
                container.className = 'relative';
                container.innerHTML = `
                    ${img.outerHTML}
                    <button type="button" onclick="removeSelectedImage(${index})" 
                            class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                elements.imagesPreview.appendChild(container);
            };
            reader.readAsDataURL(file);
        });
    }

    // Clear image selection
    function clearImageSelection() {
        selectedImages = [];
        document.getElementById('product-images').value = '';
        elements.selectedImages.classList.add('hidden');
        elements.imagesPreview.innerHTML = '';
    }

    // Remove selected image
    function removeSelectedImage(index) {
        selectedImages.splice(index, 1);
        updateImagePreview();
    }

    // Remove current image (edit mode)
    async function removeCurrentImage(index) {
        if (!editingProduct || !editingProduct.images) return;
        
        // Remove from local array
        editingProduct.images.splice(index, 1);
        
        // Update preview
        if (editingProduct.images.length > 0) {
            elements.imagesGrid.innerHTML = editingProduct.images.map((img, idx) => `
                <div class="relative">
                    <img src="${img}" alt="Product image ${idx + 1}" 
                         class="image-thumbnail" onclick="viewImage('${img}')">
                    <button type="button" onclick="removeCurrentImage(${idx})" 
                            class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        } else {
            elements.currentImages.classList.add('hidden');
        }
        
        // For edit mode, we need to update the product with new images array
        // This will be handled when the form is submitted
    }

    // Setup file upload drag and drop
    function setupFileUpload() {
        const uploadArea = document.getElementById('file-upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            document.getElementById('product-images').files = files;
            handleImageSelection({ target: { files } });
        });
    }

    // Update stock status display
    function updateStockStatus() {
        const stock = parseInt(elements.productStock.value) || 0;
        
        if (stock === 0) {
            elements.stockStatus.textContent = 'Out of Stock';
            elements.stockStatus.className = 'stock-low';
            elements.stockMessage.textContent = 'Product will be marked as unavailable';
        } else if (stock <= 10) {
            elements.stockStatus.textContent = 'Low Stock';
            elements.stockStatus.className = 'stock-medium';
            elements.stockMessage.textContent = 'Consider restocking soon';
        } else {
            elements.stockStatus.textContent = 'In Stock';
            elements.stockStatus.className = 'stock-high';
            elements.stockMessage.textContent = 'Good stock level';
        }
    }

    // View image in full screen
    function viewImage(imageUrl) {
        document.getElementById('viewer-image').src = imageUrl;
        document.getElementById('image-viewer').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // Close image viewer
    function closeImageViewer() {
        document.getElementById('image-viewer').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Start SSE for real-time updates
    function startSSE() {
        const sse = new EventSource(`${API_URL}/events/stream`);
        
        sse.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                if (data.event === 'product_added' || data.event === 'product_updated' || data.event === 'product_deleted') {
                    // Reload products when there's a change
                    loadProducts();
                }
            } catch (error) {
                console.error('SSE error:', error);
            }
        };
        
        sse.onerror = () => {
            console.log('SSE connection error, reconnecting...');
            sse.close();
            setTimeout(startSSE, 5000);
        };
    }

    // Render logged in state
    function renderLoggedIn() {
        const userSection = document.getElementById('user-section');
        const initials = ((currentUser.first_name?.[0] || '') + (currentUser.last_name?.[0] || '')).toUpperCase() || 'A';
        const name = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || 'Admin';
        
        userSection.innerHTML = `
            <div class="relative group">
                <div class="w-10 h-10 bg-gradient-to-br from-gold to-red-700 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer">
                    ${initials}
                </div>
                <div class="absolute right-0 top-12 w-64 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                    <div class="p-4 bg-gradient-to-r from-gold/5 to-red-50 border-b border-gray-200">
                        <p class="font-semibold text-deep-black">${name}</p>
                        <p class="text-sm text-gray-600">${currentUser.email}</p>
                    </div>
                    <div class="py-2">
                        <a href="/" class="block px-4 py-2 hover:bg-gray-50 transition">Home Page</a>
                        <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-red-50 hover:text-red-600 transition flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Logout
    function logout() {
        localStorage.removeItem('user');
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        window.location.href = '/admin/login';
    }

    // Helper functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function getCategoryName(category) {
        const categories = {
            'agbada': 'Agbada',
            'buba': 'Buba & Iro',
            'dansiki': 'Dansiki',
            'aso-oke': 'Aso-Oke',
            'ankara': 'Ankara',
            'gele': 'Gele & Accessories',
            'isagu': 'Isiagu (Igbo)',
            'senator': 'Senator',
            'modern': 'Modern Fusion',
            'all': 'All Products'
        };
        return categories[category] || (category ? category.charAt(0).toUpperCase() + category.slice(1) : 'Uncategorized');
    }

    function getStockClass(stock) {
        if (stock === 0) return 'stock-low';
        if (stock <= 10) return 'stock-medium';
        return 'stock-high';
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showToast(message, type = 'success') {
        // Remove existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) existingToast.remove();
        
        // Create new toast
        const toast = document.createElement('div');
        toast.className = `toast-notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>