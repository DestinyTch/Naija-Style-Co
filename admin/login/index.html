<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naija Style Co - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
   <script src="/assets/js/main.js"></script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen font-sans antialiased">
    <div class="container mx-auto px-4">
        <div class="max-w-sm mx-auto bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl md:max-w-md">
            <form id="loginForm" class="p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center text-gray-800">Admin Sign In</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-semibold mb-2" for="email">Email</label>
                    <input class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-[#BC8A1E] transition-all duration-200" id="email" type="email" placeholder="Enter your email" required>
                    <p id="emailError" class="text-red-500 text-xs italic mt-1 hidden"></p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-semibold mb-2" for="password">Password</label>
                    <input class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-[#BC8A1E] transition-all duration-200" id="password" type="password" placeholder="Enter your password" required>
                    <p id="passwordError" class="text-red-500 text-xs italic mt-1 hidden"></p>
                   
                </div>
                <button type="submit" id="loginBtn" class="bg-[#BC8A1E] hover:bg-[#A07818] text-white font-bold py-3 px-4 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-[#BC8A1E] focus:ring-offset-2 flex items-center justify-center transition-all duration-200">
                    <span>Sign In</span>
                    <svg class="ml-2 h-5 w-5 animate-spin text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
              
            </form>
           

        </div>
    </div>
    <div id="toastContainer" class="fixed bottom-4 right-4 flex flex-col space-y-2 z-50"></div>
   <script>
    async function loadEnv() {
        const paths = ['../../.env', '/.env', '/NaijaStyleCoFrontend/.env'];
        let response = null;
        for (const p of paths) {
            try {
                response = await fetch(p);
                if (response.ok) break;
            } catch (err) {
                response = null;
            }
        }
        if (!response || !response.ok) {
            console.error('Failed to load .env from any path');
            return {
                API_BASE_URL: 'http://localhost:5000'
            };
        }
        const text = await response.text();
        const env = {};
        text.split('\n').forEach(line => {
            const [key, ...valueParts] = line.split('=');
            const value = valueParts.join('=').trim();
            if (key && value) env[key.trim()] = value;
        });
        return env;
    }

    function showToast(message, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `p-4 rounded-lg shadow-lg text-white transform translate-y-4 opacity-0 transition-all duration-300 ease-in-out ${type === 'success' ? 'bg-red-600' : 'bg-red-600'}`;
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('translate-y-4', 'opacity-0');
        }, 10);
        setTimeout(() => {
            toast.classList.add('translate-y-4', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

    function validatePassword(password) {
        return password.length >= 6;
    }

    function setError(id, message) {
        const element = document.getElementById(id);
        element.textContent = message;
        element.classList.remove('hidden');
    }

    function clearError(id) {
        const element = document.getElementById(id);
        element.textContent = '';
        element.classList.add('hidden');
    }

    window.addEventListener('DOMContentLoaded', async () => {
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginForm = document.getElementById('loginForm');

        if (!loginForm) {
            console.error('Login form not found!');
            return;
        }

        const env = await loadEnv();
        const apiBaseUrl = env.API_BASE_URL || 'http://localhost:5000';

        emailInput.addEventListener('input', () => {
            clearError('emailError');
            if (emailInput.value && !validateEmail(emailInput.value)) {
                setError('emailError', 'Invalid email format');
            }
        });

        passwordInput.addEventListener('input', () => {
            clearError('passwordError');
            if (passwordInput.value && !validatePassword(passwordInput.value)) {
                setError('passwordError', 'Password must be at least 6 characters');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            clearError('emailError');
            clearError('passwordError');

            let valid = true;
            if (!validateEmail(email)) {
                setError('emailError', 'Invalid email format');
                valid = false;
            }
            if (!validatePassword(password)) {
                setError('passwordError', 'Password must be at least 6 characters');
                valid = false;
            }
            if (!valid) return;

            const btn = document.getElementById('loginBtn');
            const spinner = btn.querySelector('svg');
            const text = btn.querySelector('span');
            btn.disabled = true;
            spinner.classList.remove('hidden');
            text.textContent = 'Signing In...';

            try {
                const response = await fetch(`${apiBaseUrl}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    let errorMsg = 'Login failed';
                    if (response.status === 401) {
                        errorMsg = 'Invalid email or password';
                    } else {
                        const data = await response.json();
                        errorMsg = data.error || data.message || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                
                // Store user data in localStorage - FIXED THIS PART
                localStorage.setItem('user', JSON.stringify({
                    _id: data.user?._id || data.user?.id || data.user_id,
                    email: data.user?.email || email,
                    first_name: data.user?.first_name || '',
                    last_name: data.user?.last_name || '',
                    role: data.user?.role || 'admin'
                }));
                
                // Also store tokens if provided
                if (data.access_token) {
                    localStorage.setItem('access_token', data.access_token);
                }
                if (data.refresh_token) {
                    localStorage.setItem('refresh_token', data.refresh_token);
                }
                
                showToast('Login successful! Redirecting...', 'success');
                
                // Wait a bit then redirect to admin dashboard
                setTimeout(() => {
                    window.location.href = '/admin/orders';
                }, 1500);
            } catch (err) { 
                showToast(err.message || 'Login failed. Please try again.');
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
                text.textContent = 'Sign In';
            }
        });
    });
</script>

</body>
</html>